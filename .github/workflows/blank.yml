name: Cloud PC Setup (Tailscale Auth Key + User + RDP + Wallpaper + Dark Mode)

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: windows-latest
    timeout-minutes: 300  # 5 hours

    steps:
      - name: Install Tailscale
        shell: powershell
        run: |
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-installer.exe
          Start-Process .\tailscale-installer.exe -ArgumentList "/quiet" -Wait
          Remove-Item .\tailscale-installer.exe

      - name: Authenticate to Tailscale (using Auth Key)
        shell: cmd
        run: |
          "C:\Program Files\Tailscale\tailscale.exe" up --authkey %TS_AUTHKEY% --accept-dns=false --accept-routes=false

        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}

      - name: Create local user and grant admin/RDP
        shell: powershell
        run: |
          $pw = "act3-1234"
          $secure = ConvertTo-SecureString $pw -AsPlainText -Force

          if (-not (Get-LocalUser -Name 'clouduser' -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name 'clouduser' -Password $secure -FullName 'Cloud User' -Description 'Temporary Cloud PC user' -PasswordNeverExpires:$true
          }

          Enable-LocalUser -Name 'clouduser'
          Add-LocalGroupMember -Group "Administrators" -Member 'clouduser' -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member 'clouduser' -ErrorAction SilentlyContinue
          Write-Host "Created user 'clouduser' with password: $pw"

      - name: Download wallpaper (shared)
        shell: powershell
        run: |
          $url = "https://dro.pm/cloudus"
          $wallpaperPath = "C:\Users\Public\wallpaper.png"
          Invoke-WebRequest $url -OutFile $wallpaperPath -UseBasicParsing

      - name: Create first-logon script for dark mode, wallpaper, and Notepad
        shell: powershell
        run: |
          $publicDesktop = "C:\Users\Public\Desktop"
          New-Item -Type Directory -Path $publicDesktop -Force | Out-Null
          $msgPath = Join-Path $publicDesktop "welcome.txt"
          "ENJOY YOUR PC!" | Out-File $msgPath -Encoding UTF8

          $scriptPath = "C:\Users\Public\clouduser-firstlogon.ps1"
          @'
          $wallpaper = "C:\Users\Public\wallpaper.png"
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v AppsUseLightTheme /t REG_DWORD /d 0 /f
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v SystemUsesLightTheme /t REG_DWORD /d 0 /f
          reg add "HKCU\Control Panel\Desktop" /v Wallpaper /t REG_SZ /d "$wallpaper" /f
          RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters
          Start-Process notepad.exe "C:\Users\Public\Desktop\welcome.txt"
          '@ | Out-File $scriptPath -Encoding UTF8 -Force

          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-NoProfile -ExecutionPolicy Bypass -File `"$scriptPath`""
          $trigger = New-ScheduledTaskTrigger -AtLogOn -User "clouduser"
          $principal = New-ScheduledTaskPrincipal -UserId "clouduser" -LogonType Interactive -RunLevel Limited
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries

          if (Get-ScheduledTask -TaskName "CloudUserFirstLogon" -ErrorAction SilentlyContinue) {
            Unregister-ScheduledTask -TaskName "CloudUserFirstLogon" -Confirm:$false
          }
          Register-ScheduledTask -TaskName "CloudUserFirstLogon" -Action $action -Trigger $trigger -Principal $principal -Settings $settings

      - name: Keep runner alive for 5 hours
        shell: powershell
        run: |
          Start-Sleep -Seconds 18000
